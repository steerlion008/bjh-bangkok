{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/facebook-ads-creative/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\n\r\n// รายชื่อ video files ที่มีอยู่ใน public/images/video\r\nconst getLocalVideoFiles = (): string[] => {\r\n  try {\r\n    const videoDir = path.join(process.cwd(), \"public\", \"images\", \"video\");\r\n    if (fs.existsSync(videoDir)) {\r\n      return fs\r\n        .readdirSync(videoDir)\r\n        .filter((file) => file.endsWith(\".mp4\"))\r\n        .map((file) => file.replace(\".mp4\", \"\"));\r\n    }\r\n  } catch (error) {\r\n    console.log(\"Could not read video directory:\", error);\r\n  }\r\n  return [];\r\n};\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const accessToken = process.env.FACEBOOK_ACCESS_TOKEN;\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const adId = searchParams.get(\"ad_id\");\r\n\r\n    // Get list of local video files\r\n    const localVideoIds = getLocalVideoFiles();\r\n\r\n    if (!adId) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: \"กรุณาระบุ ad_id\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!accessToken) {\r\n      // ลองหา video ที่ match - fallback mode\r\n      const matchingVideo = localVideoIds[0]; // ใช้ video แรกเป็น default\r\n      if (matchingVideo) {\r\n        return NextResponse.json({\r\n          success: true,\r\n          data: {\r\n            id: adId,\r\n            video_id: matchingVideo,\r\n            thumbnail_url: null,\r\n          },\r\n        });\r\n      }\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: \"ไม่พบ Facebook Access Token\",\r\n        },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    // ดึงข้อมูล creative จาก ad\r\n    const fields =\r\n      \"creative{id,thumbnail_url,image_url,video_id,object_story_spec,effective_object_story_id}\";\r\n    const apiUrl = `https://graph.facebook.com/v24.0/${adId}`;\r\n    const params = new URLSearchParams({\r\n      access_token: accessToken,\r\n      fields: fields,\r\n    });\r\n    const response = await fetch(`${apiUrl}?${params.toString()}`, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n    });\r\n    if (!response.ok) {\r\n      const errorData = await response.json();\r\n      console.error(\"Facebook API Error:\", errorData);\r\n\r\n      // Fallback: ถ้า Facebook API ไม่สามารถดึงได้ ลองใช้ local video files\r\n      if (localVideoIds.length > 0) {\r\n        // ลอง match video_id จากรายการที่มี\r\n        const randomVideo =\r\n          localVideoIds[Math.floor(Math.random() * localVideoIds.length)];\r\n        return NextResponse.json({\r\n          success: true,\r\n          data: {\r\n            id: adId,\r\n            video_id: randomVideo,\r\n            thumbnail_url: null,\r\n            _fallback: true,\r\n          },\r\n        });\r\n      }\r\n\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: \"ไม่สามารถดึงข้อมูล creative ได้\",\r\n          details: errorData,\r\n        },\r\n        { status: response.status }\r\n      );\r\n    }\r\n    const data = await response.json();\r\n    const creativeData = data.creative || null;\r\n\r\n    // Try to get video_source from video_id\r\n    if (creativeData) {\r\n      const videoId =\r\n        creativeData.video_id ||\r\n        creativeData.object_story_spec?.video_data?.video_id;\r\n      if (videoId) {\r\n        try {\r\n          const videoUrl = `https://graph.facebook.com/v24.0/${videoId}`;\r\n          const videoParams = new URLSearchParams({\r\n            access_token: accessToken,\r\n            fields: \"source,picture,thumbnails\",\r\n          });\r\n          const videoResponse = await fetch(\r\n            `${videoUrl}?${videoParams.toString()}`\r\n          );\r\n          if (videoResponse.ok) {\r\n            const videoData = await videoResponse.json();\r\n            // Add video source URL\r\n            if (videoData.source) {\r\n              creativeData.video_source = videoData.source;\r\n            }\r\n            // Add thumbnail from video if not already set\r\n            if (!creativeData.thumbnail_url && videoData.picture) {\r\n              creativeData.thumbnail_url = videoData.picture;\r\n            }\r\n            // Try to get best quality thumbnail\r\n            if (videoData.thumbnails?.data?.length > 0) {\r\n              const bestThumb = videoData.thumbnails.data.reduce(\r\n                (best: any, curr: any) =>\r\n                  (curr.width || 0) > (best.width || 0) ? curr : best,\r\n                videoData.thumbnails.data[0]\r\n              );\r\n              if (bestThumb?.uri) {\r\n                creativeData.thumbnail_url = bestThumb.uri;\r\n              }\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.log(\"Could not fetch video data:\", error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Try to get image from effective_object_story_id if creative doesn't have thumbnail\r\n    if (\r\n      creativeData &&\r\n      !creativeData.thumbnail_url &&\r\n      !creativeData.image_url\r\n    ) {\r\n      const storyId = creativeData.effective_object_story_id;\r\n      if (storyId) {\r\n        try {\r\n          const storyUrl = `https://graph.facebook.com/v24.0/${storyId}`;\r\n          const storyParams = new URLSearchParams({\r\n            access_token: accessToken,\r\n            fields:\r\n              \"full_picture,picture,attachments{media,type,media_type,url}\",\r\n          });\r\n          const storyResponse = await fetch(\r\n            `${storyUrl}?${storyParams.toString()}`\r\n          );\r\n          if (storyResponse.ok) {\r\n            const storyData = await storyResponse.json();\r\n            // Add image URLs from post\r\n            if (storyData.full_picture) {\r\n              creativeData.image_url = storyData.full_picture;\r\n            } else if (storyData.picture) {\r\n              creativeData.image_url = storyData.picture;\r\n            }\r\n            // Try to get from attachments\r\n            if (storyData.attachments?.data?.[0]?.media?.image?.src) {\r\n              creativeData.thumbnail_url =\r\n                storyData.attachments.data[0].media.image.src;\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.log(\"Could not fetch story data:\", error);\r\n        }\r\n      }\r\n    }\r\n    // If still no image, try to get preview\r\n    if (\r\n      creativeData &&\r\n      !creativeData.thumbnail_url &&\r\n      !creativeData.image_url\r\n    ) {\r\n      try {\r\n        const previewUrl = `https://graph.facebook.com/v24.0/${creativeData.id}/previews`;\r\n        const previewParams = new URLSearchParams({\r\n          access_token: accessToken,\r\n          ad_format: \"DESKTOP_FEED_STANDARD\",\r\n        });\r\n        const previewResponse = await fetch(\r\n          `${previewUrl}?${previewParams.toString()}`\r\n        );\r\n        if (previewResponse.ok) {\r\n          const previewData = await previewResponse.json();\r\n          if (previewData.data?.[0]?.body) {\r\n            // Extract image URL from preview HTML\r\n            const match = previewData.data[0].body.match(\r\n              /https:\\/\\/[^\"'\\s]+\\.(jpg|jpeg|png|gif)/i\r\n            );\r\n            if (match) {\r\n              creativeData.image_url = match[0];\r\n            }\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.log(\"Could not fetch preview:\", error);\r\n      }\r\n    }\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: creativeData,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching ad creative:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: \"เกิดข้อผิดพลาดในการดึงข้อมูล creative\",\r\n        details: error instanceof Error ? error.message : \"Unknown error\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}