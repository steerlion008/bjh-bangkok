{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/lib/db.ts"],"sourcesContent":["import { Pool, types } from \"pg\";\r\n\r\n// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ pg ‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏á DATE ‡πÄ‡∏õ‡πá‡∏ô JavaScript Date object\r\n// ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ timezone shift\r\ntypes.setTypeParser(types.builtins.DATE, (val) => val); // DATE - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMP, (val) => val); // TIMESTAMP - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMPTZ, (val) => val); // TIMESTAMPTZ - return as string\r\n\r\n// ‡∏™‡∏£‡πâ‡∏≤‡∏á connection pool ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PostgreSQL (n8n.bjhbangkok.com)\r\nconst pool = new Pool({\r\n  host: process.env.DB_HOST || \"n8n.bjhbangkok.com\",\r\n  port: parseInt(process.env.DB_PORT || \"5432\"),\r\n  user: process.env.DB_USER || \"postgres\",\r\n  password: process.env.DB_PASSWORD || \"Bjh12345!!\",\r\n  database: process.env.DB_NAME || \"postgres\",\r\n  max: 20, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô connection ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 30000, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ\r\n  statement_timeout: 60000, // Query timeout 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ\r\n  query_timeout: 60000,\r\n  // n8n ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö SSL\r\n  ssl: false,\r\n});\r\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠\r\npool.on(\"connect\", () => {\r\n  // Connected to database\r\n});\r\npool.on(\"error\", (err) => {\r\n  // Database error\r\n  // ‡πÑ‡∏°‡πà exit ‡πÉ‡∏ô production ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ retry ‡πÑ‡∏î‡πâ\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    process.exit(-1);\r\n  }\r\n});\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,uDAAuD;AACvD,sCAAsC;AACtC,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,MAAQ,MAAM,0BAA0B;AAClF,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC,MAAQ,MAAM,+BAA+B;AAC5F,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC,MAAQ,MAAM,iCAAiC;AAEhG,+DAA+D;AAC/D,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,KAAK;IACL,mBAAmB;IACnB,yBAAyB;IACzB,mBAAmB;IACnB,eAAe;IACf,oBAAoB;IACpB,KAAK;AACP;AACA,sBAAsB;AACtB,KAAK,EAAE,CAAC,WAAW;AACjB,wBAAwB;AAC1B;AACA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,iBAAiB;IACjB,4CAA4C;IAC5C,wCAA2C;QACzC,QAAQ,IAAI,CAAC,CAAC;IAChB;AACF;uCACe"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { validateEmail } from \"@/utils/validateEmail\";\r\nimport pool from \"@/lib/db\";\r\nimport bcrypt from \"bcryptjs\";\r\ninterface User {\r\n  id: number;\r\n  name: string;\r\n  lname: string | null;\r\n  username: string;\r\n  password: string;\r\n  status_rank: string;\r\n  admin: boolean;\r\n  id_role: number | null;\r\n  id_dep: number | null;\r\n  position: number | null;\r\n  email: string | null;\r\n  token: string | null;\r\n  last_login: Date | null;\r\n  delete_date: Date | null;\r\n  role_name?: string;\r\n  role_tag?: string;\r\n  back_end?: boolean;\r\n  department_name?: string;\r\n  department_name_fix?: string;\r\n  position_name?: string;\r\n}\r\nexport async function POST(request: NextRequest) {\r\n  const client = await pool.connect();\r\n  try {\r\n    const body = await request.json();\r\n    const { email, password, rememberMe } = body;\r\n    // Validate input\r\n    if (!email || !password) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: \"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    // Validate password length\r\n    if (password.length < 6) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: \"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    // Find user by email or username\r\n    const userQuery = `\r\n      SELECT \r\n        u.*,\r\n        u.name AS fname,\r\n        r.name AS role_name,\r\n        r.tag AS role_tag,\r\n        r.back_end,\r\n        d.name AS department_name_fix,\r\n        d.name_full_th AS department_name,\r\n        p.name_full_th AS position_name\r\n      FROM \"BJH-Server\".\"user\" u\r\n      LEFT JOIN \"BJH-Server\".roles r ON u.id_role = r.id_role\r\n      LEFT JOIN \"BJH-Server\".department d ON u.id_dep = d.id\r\n      LEFT JOIN \"BJH-Server\".\"position\" p ON u.position = p.id\r\n      WHERE (u.email = $1 OR u.username = $1)\r\n        AND u.delete_date IS NULL\r\n      LIMIT 1\r\n    `;\r\n    console.log(\"üîç Searching for user with:\", email);\r\n    const userResult = await client.query(userQuery, [email]);\r\n    console.log(\"üìä Query result:\", userResult.rows.length, \"rows found\");\r\n    if (userResult.rows.length === 0) {\r\n      console.log(\"‚ùå User not found for:\", email);\r\n      return NextResponse.json(\r\n        { success: false, message: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${email}` },\r\n        { status: 401 }\r\n      );\r\n    }\r\n    const user: User = userResult.rows[0];\r\n    // Verify password - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á bcrypt ($2b$) ‡πÅ‡∏•‡∏∞ PHP password_hash ($2y$)\r\n    let isPasswordValid = false;\r\n    try {\r\n      // ‡πÅ‡∏õ‡∏•‡∏á $2y$ (PHP) ‡πÄ‡∏õ‡πá‡∏ô $2b$ (Node.js) ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô\r\n      const hashToCompare = user.password.startsWith(\"$2y$\")\r\n        ? user.password.replace(\"$2y$\", \"$2b$\")\r\n        : user.password;\r\n      console.log(\"üîê Password input:\", password);\r\n      console.log(\"üîë Hash from DB:\", user.password.substring(0, 20) + \"...\");\r\n      console.log(\r\n        \"üîÑ Hash to compare:\",\r\n        hashToCompare.substring(0, 20) + \"...\"\r\n      );\r\n      isPasswordValid = await bcrypt.compare(password, hashToCompare);\r\n      console.log(\"‚úÖ Password match result:\", isPasswordValid);\r\n    } catch (error) {\r\n      console.error(\"‚ùå Password verification error:\", error);\r\n    }\r\n    if (!isPasswordValid) {\r\n      return NextResponse.json(\r\n        { success: false, message: \"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n    // Get user avatar\r\n    const avatarQuery = `\r\n      SELECT path, name_file\r\n      FROM \"BJH-Server\".parth_file\r\n      WHERE id_ref = $1 \r\n        AND prefix = 'user_img' \r\n        AND delete_date IS NULL\r\n      LIMIT 1\r\n    `;\r\n    const avatarResult = await client.query(avatarQuery, [user.id]);\r\n    let avatarPath = \"/images/user.png\";\r\n    if (avatarResult.rows.length > 0) {\r\n      const avatar = avatarResult.rows[0];\r\n      avatarPath = `${avatar.path}${avatar.name_file}`;\r\n    }\r\n    // Generate simple token (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ JWT)\r\n    const token = Buffer.from(\r\n      `${user.id}:${Date.now()}:${Math.random()}`\r\n    ).toString(\"base64\");\r\n    // Update last login and token\r\n    await client.query(\r\n      `UPDATE \"BJH-Server\".\"user\" \r\n       SET last_login = CURRENT_TIMESTAMP, token = $1 \r\n       WHERE id = $2`,\r\n      [token, user.id]\r\n    );\r\n    // Prepare user data (exclude sensitive info)\r\n    const userData = {\r\n      id: user.id,\r\n      name: user.name,\r\n      lname: user.lname,\r\n      username: user.username,\r\n      email: user.email,\r\n      status_rank: user.status_rank,\r\n      admin: user.admin,\r\n      role_name: user.role_name || \"\",\r\n      role_tag: user.role_tag || \"\",\r\n      back_end: user.back_end || false,\r\n      department_name: user.department_name || \"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\",\r\n      department_name_fix: user.department_name_fix || \"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\",\r\n      position_name: user.position_name || \"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\",\r\n      avatar: avatarPath,\r\n    };\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${user.name}`,\r\n      token,\r\n      user: userData,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Login error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        message: \"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r"],"names":[],"mappings":"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"}}]
}