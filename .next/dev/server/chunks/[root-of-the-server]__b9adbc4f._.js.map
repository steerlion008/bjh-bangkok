{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/facebook-ads-balance-page2/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\nexport async function GET() {\r\n  try {\r\n    // Access token และ Ad Account ID สำหรับ Page 2\r\n    const accessToken =\r\n      \"EAAPb1ZBYCiNcBPzNxxSUntCZCTVHyl5AkAZBIiwCmDzrWKMLU4VEHJxRve7oqUDSaMs8om9pdVWFLzUdeTbTvkGPuTeuQ4KvGFizMy3VsSid8vgmjZB8OMoLySRmXxyAUpAwyyhSqOO8tSZAU6IYpxarsXBbZCDzFdy8u279HxSXtyWMpIolRtjJEWLdmfU5SwZCsP5\";\r\n    const adAccountId = \"act_869492750129928\";\r\n\r\n    // Fields ที่ต้องดึง\r\n    const fields =\r\n      \"account_id,name,account_status,balance,amount_spent,currency,funding_source_details,min_daily_budget,spend_cap\";\r\n\r\n    // สร้าง URL สำหรับ Facebook Graph API\r\n    const apiUrl = `https://graph.facebook.com/v24.0/${adAccountId}?fields=${fields}&access_token=${accessToken}`;\r\n\r\n    console.log(\r\n      \"[Page 2 Balance API] Fetching from:\",\r\n      apiUrl.replace(accessToken, \"***TOKEN***\")\r\n    );\r\n\r\n    // เรียก Facebook Graph API\r\n    const response = await fetch(apiUrl, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      cache: \"no-store\",\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorData = await response.json();\r\n      console.error(\"[Page 2 Balance API] Facebook API Error:\", errorData);\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: \"ไม่สามารถดึงข้อมูล Balance จาก Facebook Ads API ได้\",\r\n          details: errorData,\r\n        },\r\n        { status: response.status }\r\n      );\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    // Facebook คืนค่า balance และ amount_spent เป็นหน่วย cent (หารด้วย 100 เพื่อแปลงเป็นหน่วยปกติ)\r\n    const balanceRaw = parseInt(data.balance || \"0\");\r\n    const amountSpentRaw = parseInt(data.amount_spent || \"0\");\r\n    const minDailyBudgetRaw = parseInt(data.min_daily_budget || \"0\");\r\n    const spendCapRaw = parseInt(data.spend_cap || \"0\");\r\n\r\n    // แปลงจาก cent เป็นหน่วยปกติ (หาร 100)\r\n    const balance = balanceRaw / 100;\r\n    const amountSpent = amountSpentRaw / 100;\r\n    const minDailyBudget = minDailyBudgetRaw / 100;\r\n    const spendCap = spendCapRaw / 100;\r\n\r\n    console.log(\r\n      \"[Page 2 Balance API] Success - Balance:\",\r\n      balance,\r\n      data.currency\r\n    );\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        account_id: data.account_id,\r\n        name: data.name,\r\n        account_status: data.account_status,\r\n        balance: balance,\r\n        balance_raw: balanceRaw,\r\n        amount_spent: amountSpent,\r\n        amount_spent_raw: amountSpentRaw,\r\n        currency: data.currency || \"THB\",\r\n        funding_source_details: data.funding_source_details || null,\r\n        min_daily_budget: minDailyBudget,\r\n        spend_cap: spendCap,\r\n        // Available balance = balance (prepaid) หรือ spend_cap - amount_spent (credit)\r\n        available_balance:\r\n          balance > 0 ? balance : Math.max(0, spendCap - amountSpent),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[Page 2 Balance API] Error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: \"เกิดข้อผิดพลาดในการดึงข้อมูล Balance\",\r\n        details: error instanceof Error ? error.message : \"Unknown error\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe;IACpB,IAAI;QACF,+CAA+C;QAC/C,MAAM,cACJ;QACF,MAAM,cAAc;QAEpB,oBAAoB;QACpB,MAAM,SACJ;QAEF,sCAAsC;QACtC,MAAM,SAAS,CAAC,iCAAiC,EAAE,YAAY,QAAQ,EAAE,OAAO,cAAc,EAAE,aAAa;QAE7G,QAAQ,GAAG,CACT,uCACA,OAAO,OAAO,CAAC,aAAa;QAG9B,2BAA2B;QAC3B,MAAM,WAAW,MAAM,MAAM,QAAQ;YACnC,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,OAAO;QACT;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,QAAQ,KAAK,CAAC,4CAA4C;YAC1D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO;gBACP,SAAS;YACX,GACA;gBAAE,QAAQ,SAAS,MAAM;YAAC;QAE9B;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,+FAA+F;QAC/F,MAAM,aAAa,SAAS,KAAK,OAAO,IAAI;QAC5C,MAAM,iBAAiB,SAAS,KAAK,YAAY,IAAI;QACrD,MAAM,oBAAoB,SAAS,KAAK,gBAAgB,IAAI;QAC5D,MAAM,cAAc,SAAS,KAAK,SAAS,IAAI;QAE/C,uCAAuC;QACvC,MAAM,UAAU,aAAa;QAC7B,MAAM,cAAc,iBAAiB;QACrC,MAAM,iBAAiB,oBAAoB;QAC3C,MAAM,WAAW,cAAc;QAE/B,QAAQ,GAAG,CACT,2CACA,SACA,KAAK,QAAQ;QAGf,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,YAAY,KAAK,UAAU;gBAC3B,MAAM,KAAK,IAAI;gBACf,gBAAgB,KAAK,cAAc;gBACnC,SAAS;gBACT,aAAa;gBACb,cAAc;gBACd,kBAAkB;gBAClB,UAAU,KAAK,QAAQ,IAAI;gBAC3B,wBAAwB,KAAK,sBAAsB,IAAI;gBACvD,kBAAkB;gBAClB,WAAW;gBACX,+EAA+E;gBAC/E,mBACE,UAAU,IAAI,UAAU,KAAK,GAAG,CAAC,GAAG,WAAW;YACnD;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}