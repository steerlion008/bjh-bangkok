{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/lib/db.ts"],"sourcesContent":["import { Pool, types } from \"pg\";\r\n\r\n// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ pg ‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏á DATE ‡πÄ‡∏õ‡πá‡∏ô JavaScript Date object\r\n// ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ timezone shift\r\ntypes.setTypeParser(types.builtins.DATE, (val) => val); // DATE - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMP, (val) => val); // TIMESTAMP - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMPTZ, (val) => val); // TIMESTAMPTZ - return as string\r\n\r\n// ‡∏™‡∏£‡πâ‡∏≤‡∏á connection pool ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PostgreSQL (n8n.bjhbangkok.com)\r\nconst pool = new Pool({\r\n  host: process.env.DB_HOST || \"n8n.bjhbangkok.com\",\r\n  port: parseInt(process.env.DB_PORT || \"5432\"),\r\n  user: process.env.DB_USER || \"postgres\",\r\n  password: process.env.DB_PASSWORD || \"Bjh12345!!\",\r\n  database: process.env.DB_NAME || \"postgres\",\r\n  max: 20, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô connection ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 30000, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ\r\n  statement_timeout: 60000, // Query timeout 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ\r\n  query_timeout: 60000,\r\n  // n8n ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö SSL\r\n  ssl: false,\r\n});\r\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠\r\npool.on(\"connect\", () => {\r\n  // Connected to database\r\n});\r\npool.on(\"error\", (err) => {\r\n  // Database error\r\n  // ‡πÑ‡∏°‡πà exit ‡πÉ‡∏ô production ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ retry ‡πÑ‡∏î‡πâ\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    process.exit(-1);\r\n  }\r\n});\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,uDAAuD;AACvD,sCAAsC;AACtC,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,MAAQ,MAAM,0BAA0B;AAClF,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC,MAAQ,MAAM,+BAA+B;AAC5F,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC,MAAQ,MAAM,iCAAiC;AAEhG,+DAA+D;AAC/D,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,KAAK;IACL,mBAAmB;IACnB,yBAAyB;IACzB,mBAAmB;IACnB,eAAe;IACf,oBAAoB;IACpB,KAAK;AACP;AACA,sBAAsB;AACtB,KAAK,EAAE,CAAC,WAAW;AACjB,wBAAwB;AAC1B;AACA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,iBAAiB;IACjB,4CAA4C;IAC5C,wCAA2C;QACzC,QAAQ,IAAI,CAAC,CAAC;IAChB;AACF;uCACe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/facebook-ads-phone-leads-sql/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport pool from \"@/lib/db\";\r\n\r\nexport async function GET(request: NextRequest) {\r\n  let client;\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const adIdsParam = searchParams.get(\"ad_ids\"); // Format: comma-separated fb_ad_id (optional)\r\n    const dateStartParam = searchParams.get(\"date_start\"); // Format: YYYY-MM-DD (optional)\r\n    const dateEndParam = searchParams.get(\"date_end\"); // Format: YYYY-MM-DD (optional)\r\n\r\n    console.log(\"üìû [Phone Leads SQL API] Request params:\", {\r\n      adIdsParam,\r\n      dateStartParam,\r\n      dateEndParam,\r\n    });\r\n\r\n    client = await pool.connect();\r\n    console.log(\"‚úÖ [Phone Leads SQL API] Database connected successfully\");\r\n\r\n    // Build SQL query based on the new schema\r\n    let query: string;\r\n    const queryParams: any[] = [];\r\n\r\n    if (adIdsParam) {\r\n      // Query for specific fb_ad_ids - group by fb_ad_id\r\n      const adIds = adIdsParam.split(\",\").map((id) => id.trim());\r\n      query = `\r\n        SELECT\r\n          ads.fb_ad_id,\r\n          ads.ad_name,\r\n          COUNT(DISTINCT ct.customer_id) AS customers_with_phone\r\n        FROM \"BJH-Server\".fb_customer_tags AS ct\r\n        JOIN \"BJH-Server\".fb_tags AS t\r\n          ON t.id = ct.tag_id\r\n        JOIN \"BJH-Server\".fb_conversations AS conv\r\n          ON conv.customer_id = ct.customer_id\r\n        JOIN \"BJH-Server\".fb_conversation_sources AS src\r\n          ON src.conversation_id = conv.id\r\n        JOIN \"BJH-Server\".fb_ads AS ads\r\n          ON ads.id = src.ad_id\r\n        WHERE t.name = 'phone'\r\n          AND ads.fb_ad_id = ANY($1)`;\r\n      queryParams.push(adIds);\r\n\r\n      // Add date range filter if provided\r\n      if (dateStartParam && dateEndParam) {\r\n        query += `\r\n          AND ct.assigned_at::date BETWEEN $2 AND $3`;\r\n        queryParams.push(dateStartParam, dateEndParam);\r\n      } else if (dateStartParam) {\r\n        query += `\r\n          AND ct.assigned_at::date >= $2`;\r\n        queryParams.push(dateStartParam);\r\n      } else if (dateEndParam) {\r\n        query += `\r\n          AND ct.assigned_at::date <= $2`;\r\n        queryParams.push(dateEndParam);\r\n      }\r\n\r\n      query += `\r\n        GROUP BY\r\n          ads.fb_ad_id,\r\n          ads.ad_name\r\n        ORDER BY\r\n          customers_with_phone DESC\r\n      `;\r\n    } else {\r\n      // Query for all ad_ids with phone leads\r\n      query = `\r\n        SELECT\r\n          ads.fb_ad_id,\r\n          ads.ad_name,\r\n          COUNT(DISTINCT ct.customer_id) AS customers_with_phone\r\n        FROM \"BJH-Server\".fb_customer_tags AS ct\r\n        JOIN \"BJH-Server\".fb_tags AS t\r\n          ON t.id = ct.tag_id\r\n        JOIN \"BJH-Server\".fb_conversations AS conv\r\n          ON conv.customer_id = ct.customer_id\r\n        JOIN \"BJH-Server\".fb_conversation_sources AS src\r\n          ON src.conversation_id = conv.id\r\n        JOIN \"BJH-Server\".fb_ads AS ads\r\n          ON ads.id = src.ad_id\r\n        WHERE t.name = 'phone'`;\r\n\r\n      // Add date range filter if provided\r\n      if (dateStartParam && dateEndParam) {\r\n        query += `\r\n          AND ct.assigned_at::date BETWEEN $1 AND $2`;\r\n        queryParams.push(dateStartParam, dateEndParam);\r\n      } else if (dateStartParam) {\r\n        query += `\r\n          AND ct.assigned_at::date >= $1`;\r\n        queryParams.push(dateStartParam);\r\n      } else if (dateEndParam) {\r\n        query += `\r\n          AND ct.assigned_at::date <= $1`;\r\n        queryParams.push(dateEndParam);\r\n      }\r\n\r\n      query += `\r\n        GROUP BY\r\n          ads.fb_ad_id,\r\n          ads.ad_name\r\n        ORDER BY\r\n          customers_with_phone DESC\r\n      `;\r\n    }\r\n\r\n    console.log(\"üìû [Phone Leads SQL API] Executing query:\", query);\r\n    console.log(\"üìû [Phone Leads SQL API] Query params:\", queryParams);\r\n\r\n    const result = await client.query(query, queryParams);\r\n    console.log(\r\n      \"‚úÖ [Phone Leads SQL API] Query result:\",\r\n      result.rows.length,\r\n      \"rows\"\r\n    );\r\n    console.log(\r\n      \"üìä [Phone Leads SQL API] Sample data:\",\r\n      result.rows.slice(0, 5)\r\n    );\r\n\r\n    // Convert to map for easy lookup\r\n    // Format: { \"fb_ad_id_1\": count, \"fb_ad_id_2\": count, ... }\r\n    const phoneLeadsMap: { [key: string]: number } = {};\r\n\r\n    result.rows.forEach((row) => {\r\n      phoneLeadsMap[row.fb_ad_id] = parseInt(row.customers_with_phone) || 0;\r\n      console.log(\r\n        `  üìç Ad ${row.fb_ad_id} (${row.ad_name}): ${row.customers_with_phone} phone leads`\r\n      );\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: phoneLeadsMap,\r\n      details: result.rows,\r\n      count: result.rows.length,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå [Phone Leads SQL API] Error:\", error);\r\n    console.error(\"‚ùå [Phone Leads SQL API] Error stack:\", error?.stack);\r\n    console.error(\"‚ùå [Phone Leads SQL API] Error name:\", error?.name);\r\n    console.error(\"‚ùå [Phone Leads SQL API] Error message:\", error?.message);\r\n    // Return empty data instead of error to prevent breaking the UI\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: \"Failed to fetch phone leads data\",\r\n      details: error?.message || error?.toString() || \"Unknown error\",\r\n      errorType: error?.name || \"Error\",\r\n      data: {}, // Return empty object so the UI can handle it gracefully\r\n    });\r\n  } finally {\r\n    // Release the client back to the pool\r\n    if (client) {\r\n      client.release();\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}