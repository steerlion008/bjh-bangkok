{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/lib/db.ts"],"sourcesContent":["import { Pool, types } from \"pg\";\r\n\r\n// กำหนดให้ pg ไม่แปลง DATE เป็น JavaScript Date object\r\n// เพื่อหลีกเลี่ยงปัญหา timezone shift\r\ntypes.setTypeParser(types.builtins.DATE, (val) => val); // DATE - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMP, (val) => val); // TIMESTAMP - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMPTZ, (val) => val); // TIMESTAMPTZ - return as string\r\n\r\n// สร้าง connection pool สำหรับ PostgreSQL (n8n.bjhbangkok.com)\r\nconst pool = new Pool({\r\n  host: process.env.DB_HOST || \"n8n.bjhbangkok.com\",\r\n  port: parseInt(process.env.DB_PORT || \"5432\"),\r\n  user: process.env.DB_USER || \"postgres\",\r\n  password: process.env.DB_PASSWORD || \"Bjh12345!!\",\r\n  database: process.env.DB_NAME || \"postgres\",\r\n  max: 20, // จำนวน connection สูงสุด\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 30000, // เพิ่มเป็น 30 วินาที\r\n  statement_timeout: 60000, // Query timeout 60 วินาที\r\n  query_timeout: 60000,\r\n  // n8n ไม่รองรับ SSL\r\n  ssl: false,\r\n});\r\n// ตรวจสอบการเชื่อมต่อ\r\npool.on(\"connect\", () => {\r\n  // Connected to database\r\n});\r\npool.on(\"error\", (err) => {\r\n  // Database error\r\n  // ไม่ exit ใน production เพื่อให้ retry ได้\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    process.exit(-1);\r\n  }\r\n});\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,uDAAuD;AACvD,sCAAsC;AACtC,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,MAAQ,MAAM,0BAA0B;AAClF,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC,MAAQ,MAAM,+BAA+B;AAC5F,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC,MAAQ,MAAM,iCAAiC;AAEhG,+DAA+D;AAC/D,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,KAAK;IACL,mBAAmB;IACnB,yBAAyB;IACzB,mBAAmB;IACnB,eAAe;IACf,oBAAoB;IACpB,KAAK;AACP;AACA,sBAAsB;AACtB,KAAK,EAAE,CAAC,WAAW;AACjB,wBAAwB;AAC1B;AACA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,iBAAiB;IACjB,4CAA4C;IAC5C,wCAA2C;QACzC,QAAQ,IAAI,CAAC,CAAC;IAChB;AACF;uCACe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/status-options/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport pool from \"@/lib/db\";\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // Test connection first\r\n    const testResult = await pool.query(\"SELECT 1 as test\");\r\n    console.log(\"✅ Database connection successful\");\r\n    // Try multiple schema name formats\r\n    let query = `\r\n      SELECT \r\n        id,\r\n        value,\r\n        label,\r\n        color,\r\n        display_order,\r\n        is_active\r\n      FROM status_options\r\n      WHERE is_active = true\r\n      ORDER BY display_order ASC\r\n    `;\r\n    let result;\r\n    try {\r\n      // Try without schema first\r\n      result = await pool.query(query);\r\n      console.log(`✅ Found ${result.rows.length} status options (no schema)`);\r\n    } catch (err1) {\r\n      console.log(\r\n        \"⚠️ Failed without schema, trying with 'BJH-Server' schema...\"\r\n      );\r\n      try {\r\n        // Try with BJH-Server schema\r\n        query = `\r\n          SELECT \r\n            id,\r\n            value,\r\n            label,\r\n            color,\r\n            display_order,\r\n            is_active\r\n          FROM \"BJH-Server\".status_options\r\n          WHERE is_active = true\r\n          ORDER BY display_order ASC\r\n        `;\r\n        result = await pool.query(query);\r\n        console.log(\r\n          `✅ Found ${result.rows.length} status options (BJH-Server schema)`\r\n        );\r\n      } catch (err2) {\r\n        console.log(\r\n          \"⚠️ Failed with BJH-Server, trying with 'public' schema...\"\r\n        );\r\n        // Try with public schema\r\n        query = `\r\n          SELECT \r\n            id,\r\n            value,\r\n            label,\r\n            color,\r\n            display_order,\r\n            is_active\r\n          FROM public.status_options\r\n          WHERE is_active = true\r\n          ORDER BY display_order ASC\r\n        `;\r\n        result = await pool.query(query);\r\n        console.log(\r\n          `✅ Found ${result.rows.length} status options (public schema)`\r\n        );\r\n      }\r\n    }\r\n    // Transform data to match the format expected by the frontend\r\n    const statusOptions = result.rows.map((row) => ({\r\n      value: row.value,\r\n      label: row.label,\r\n      color: row.color,\r\n    }));\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: statusOptions,\r\n      count: statusOptions.length,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"❌ Error fetching status options:\", error);\r\n    console.error(\"Error details:\", {\r\n      message: error.message,\r\n      code: error.code,\r\n      detail: error.detail,\r\n      stack: error.stack?.split(\"\\n\").slice(0, 3).join(\"\\n\"),\r\n    });\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: \"Failed to fetch status options\",\r\n        details: error.message || error.code || \"Unknown database error\",\r\n        hint: \"Check if the table 'status_options' exists and DATABASE_URL is correct\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n// POST method for adding new status option\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { action, data } = body;\r\n    if (action === \"create\") {\r\n      const { value, label, color, display_order } = data;\r\n      // Insert new status option\r\n      const query = `\r\n        INSERT INTO \"BJH-Server\".status_options \r\n        (value, label, color, display_order, is_active)\r\n        VALUES ($1, $2, $3, $4, true)\r\n        RETURNING *\r\n      `;\r\n      const result = await pool.query(query, [\r\n        value,\r\n        label,\r\n        color,\r\n        display_order || 999,\r\n      ]);\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: result.rows[0],\r\n        message: \"Status option created successfully\",\r\n      });\r\n    } else if (action === \"update\") {\r\n      const { id, value, label, color, display_order } = data;\r\n      // Update existing status option\r\n      const query = `\r\n        UPDATE \"BJH-Server\".status_options \r\n        SET value = $1, label = $2, color = $3, display_order = $4, updated_at = CURRENT_TIMESTAMP\r\n        WHERE id = $5\r\n        RETURNING *\r\n      `;\r\n      const result = await pool.query(query, [\r\n        value,\r\n        label,\r\n        color,\r\n        display_order,\r\n        id,\r\n      ]);\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: result.rows[0],\r\n        message: \"Status option updated successfully\",\r\n      });\r\n    } else if (action === \"delete\") {\r\n      const { id } = data;\r\n      // Soft delete - set is_active to false\r\n      const query = `\r\n        UPDATE \"BJH-Server\".status_options \r\n        SET is_active = false, updated_at = CURRENT_TIMESTAMP\r\n        WHERE id = $1\r\n        RETURNING *\r\n      `;\r\n      const result = await pool.query(query, [id]);\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: result.rows[0],\r\n        message: \"Status option deleted successfully\",\r\n      });\r\n    } else {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: \"Invalid action. Use 'create', 'update', or 'delete'\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"❌ Error modifying status options:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: \"Failed to modify status options\",\r\n        details: error.message,\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}