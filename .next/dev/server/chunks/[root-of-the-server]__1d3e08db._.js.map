{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/lib/db.ts"],"sourcesContent":["import { Pool, types } from \"pg\";\r\n\r\n// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ pg ‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏á DATE ‡πÄ‡∏õ‡πá‡∏ô JavaScript Date object\r\n// ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ timezone shift\r\ntypes.setTypeParser(types.builtins.DATE, (val) => val); // DATE - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMP, (val) => val); // TIMESTAMP - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMPTZ, (val) => val); // TIMESTAMPTZ - return as string\r\n\r\n// ‡∏™‡∏£‡πâ‡∏≤‡∏á connection pool ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PostgreSQL (n8n.bjhbangkok.com)\r\nconst pool = new Pool({\r\n  host: process.env.DB_HOST || \"n8n.bjhbangkok.com\",\r\n  port: parseInt(process.env.DB_PORT || \"5432\"),\r\n  user: process.env.DB_USER || \"postgres\",\r\n  password: process.env.DB_PASSWORD || \"Bjh12345!!\",\r\n  database: process.env.DB_NAME || \"postgres\",\r\n  max: 20, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô connection ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 30000, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ\r\n  statement_timeout: 60000, // Query timeout 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ\r\n  query_timeout: 60000,\r\n  // n8n ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö SSL\r\n  ssl: false,\r\n});\r\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠\r\npool.on(\"connect\", () => {\r\n  // Connected to database\r\n});\r\npool.on(\"error\", (err) => {\r\n  // Database error\r\n  // ‡πÑ‡∏°‡πà exit ‡πÉ‡∏ô production ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ retry ‡πÑ‡∏î‡πâ\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    process.exit(-1);\r\n  }\r\n});\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,uDAAuD;AACvD,sCAAsC;AACtC,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,MAAQ,MAAM,0BAA0B;AAClF,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC,MAAQ,MAAM,+BAA+B;AAC5F,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC,MAAQ,MAAM,iCAAiC;AAEhG,+DAA+D;AAC/D,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,KAAK;IACL,mBAAmB;IACnB,yBAAyB;IACzB,mBAAmB;IACnB,eAAe;IACf,oBAAoB;IACpB,KAAK;AACP;AACA,sBAAsB;AACtB,KAAK,EAAE,CAAC,WAAW;AACjB,wBAAwB;AAC1B;AACA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,iBAAiB;IACjB,4CAA4C;IAC5C,wCAA2C;QACzC,QAAQ,IAAI,CAAC,CAAC;IAChB;AACF;uCACe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/facebook-ads-phone-leads/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport pool from \"@/lib/db\";\r\nexport async function GET(request: NextRequest) {\r\n  let client;\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const dateParam = searchParams.get(\"date\"); // Format: YYYY-MM-DD (optional)\r\n    const adIdsParam = searchParams.get(\"ad_ids\"); // Format: comma-separated ad IDs (optional)\r\n\r\n    console.log(\"üìû [Phone Leads API] Request params:\", {\r\n      dateParam,\r\n      adIdsParam,\r\n    });\r\n\r\n    client = await pool.connect();\r\n    console.log(\"‚úÖ [Phone Leads API] Database connected successfully\");\r\n\r\n    // Build SQL query - Group by date OR by ad_id\r\n    let query: string;\r\n    const queryParams: any[] = [];\r\n\r\n    if (adIdsParam) {\r\n      // Query for specific ad IDs - group by ad_id\r\n      const adIds = adIdsParam.split(\",\").map((id) => id.trim());\r\n      query = `\r\n        SELECT\r\n          c.ad_id,\r\n          COUNT(DISTINCT ct.customer_id) AS customers_with_phone\r\n        FROM \"BJH-Server\".fb_customer_tags ct\r\n        JOIN \"BJH-Server\".fb_tags t ON t.id = ct.tag_id\r\n        JOIN \"BJH-Server\".fb_customers c ON c.id = ct.customer_id\r\n        WHERE t.name = 'phone'\r\n          AND c.ad_id = ANY($1)\r\n        GROUP BY c.ad_id\r\n      `;\r\n      queryParams.push(adIds);\r\n    } else {\r\n      // Query for all dates - group by date\r\n      query = `\r\n        SELECT\r\n          ct.assigned_at::date AS date,\r\n          COUNT(DISTINCT ct.customer_id) AS customers_with_phone\r\n        FROM \"BJH-Server\".fb_customer_tags ct\r\n        JOIN \"BJH-Server\".fb_tags t ON t.id = ct.tag_id\r\n        WHERE t.name = 'phone'\r\n      `;\r\n\r\n      // Add date filter if provided (for single date)\r\n      if (dateParam) {\r\n        queryParams.push(dateParam);\r\n        query += ` AND ct.assigned_at::date = $${queryParams.length}`;\r\n      }\r\n\r\n      query += `\r\n        GROUP BY ct.assigned_at::date\r\n        ORDER BY date DESC\r\n      `;\r\n    }\r\n\r\n    console.log(\"üìû [Phone Leads API] Executing query:\", query);\r\n    console.log(\"üìû [Phone Leads API] Query params:\", queryParams);\r\n\r\n    const result = await client.query(query, queryParams);\r\n    console.log(\r\n      \"‚úÖ [Phone Leads API] Query result:\",\r\n      result.rows.length,\r\n      \"rows\"\r\n    );\r\n    console.log(\"üìä [Phone Leads API] Sample data:\", result.rows.slice(0, 3));\r\n\r\n    // Convert to map for easy lookup\r\n    const phoneLeadsMap: { [key: string]: number } = {};\r\n\r\n    if (adIdsParam) {\r\n      // Format: { \"ad_id_1\": count, \"ad_id_2\": count, ... }\r\n      result.rows.forEach((row) => {\r\n        phoneLeadsMap[row.ad_id] = parseInt(row.customers_with_phone) || 0;\r\n        console.log(\r\n          `  üìç Ad ${row.ad_id}: ${row.customers_with_phone} phone leads`\r\n        );\r\n      });\r\n    } else {\r\n      // Format: { \"YYYY-MM-DD\": count, ... }\r\n      result.rows.forEach((row) => {\r\n        const date = new Date(row.date);\r\n        const year = date.getFullYear();\r\n        const month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n        const day = String(date.getDate()).padStart(2, \"0\");\r\n        const dateStr = `${year}-${month}-${day}`;\r\n        phoneLeadsMap[dateStr] = parseInt(row.customers_with_phone) || 0;\r\n        console.log(\r\n          `  üìç Date ${dateStr}: ${row.customers_with_phone} phone leads`\r\n        );\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: phoneLeadsMap,\r\n      details: result.rows,\r\n      count: result.rows.length,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå [Phone Leads API] Error:\", error);\r\n    console.error(\"‚ùå [Phone Leads API] Error stack:\", error?.stack);\r\n    console.error(\"‚ùå [Phone Leads API] Error name:\", error?.name);\r\n    console.error(\"‚ùå [Phone Leads API] Error message:\", error?.message);\r\n    // Return empty data instead of error to prevent breaking the UI\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: \"Failed to fetch phone leads data\",\r\n      details: error?.message || error?.toString() || \"Unknown error\",\r\n      errorType: error?.name || \"Error\",\r\n      data: {}, // Return empty object so the UI can handle it gracefully\r\n    });\r\n  } finally {\r\n    // Release the client back to the pool\r\n    if (client) {\r\n      client.release();\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}