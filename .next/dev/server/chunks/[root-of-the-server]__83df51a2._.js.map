{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/lib/db.ts"],"sourcesContent":["import { Pool, types } from \"pg\";\r\n\r\n// กำหนดให้ pg ไม่แปลง DATE เป็น JavaScript Date object\r\n// เพื่อหลีกเลี่ยงปัญหา timezone shift\r\ntypes.setTypeParser(types.builtins.DATE, (val) => val); // DATE - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMP, (val) => val); // TIMESTAMP - return as string\r\ntypes.setTypeParser(types.builtins.TIMESTAMPTZ, (val) => val); // TIMESTAMPTZ - return as string\r\n\r\n// สร้าง connection pool สำหรับ PostgreSQL (n8n.bjhbangkok.com)\r\nconst pool = new Pool({\r\n  host: process.env.DB_HOST || \"n8n.bjhbangkok.com\",\r\n  port: parseInt(process.env.DB_PORT || \"5432\"),\r\n  user: process.env.DB_USER || \"postgres\",\r\n  password: process.env.DB_PASSWORD || \"Bjh12345!!\",\r\n  database: process.env.DB_NAME || \"postgres\",\r\n  max: 20, // จำนวน connection สูงสุด\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 30000, // เพิ่มเป็น 30 วินาที\r\n  statement_timeout: 60000, // Query timeout 60 วินาที\r\n  query_timeout: 60000,\r\n  // n8n ไม่รองรับ SSL\r\n  ssl: false,\r\n});\r\n// ตรวจสอบการเชื่อมต่อ\r\npool.on(\"connect\", () => {\r\n  // Connected to database\r\n});\r\npool.on(\"error\", (err) => {\r\n  // Database error\r\n  // ไม่ exit ใน production เพื่อให้ retry ได้\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    process.exit(-1);\r\n  }\r\n});\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,uDAAuD;AACvD,sCAAsC;AACtC,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,MAAQ,MAAM,0BAA0B;AAClF,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC,MAAQ,MAAM,+BAA+B;AAC5F,6GAAK,CAAC,aAAa,CAAC,6GAAK,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC,MAAQ,MAAM,iCAAiC;AAEhG,+DAA+D;AAC/D,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,KAAK;IACL,mBAAmB;IACnB,yBAAyB;IACzB,mBAAmB;IACnB,eAAe;IACf,oBAAoB;IACpB,KAAK;AACP;AACA,sBAAsB;AACtB,KAAK,EAAE,CAAC,WAAW;AACjB,wBAAwB;AAC1B;AACA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,iBAAiB;IACjB,4CAA4C;IAC5C,wCAA2C;QACzC,QAAQ,IAAI,CAAC,CAAC;IAChB;AACF;uCACe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nut_z/OneDrive/%E0%B9%80%E0%B8%94%E0%B8%AA%E0%B8%81%E0%B9%8C%E0%B8%97%E0%B9%87%E0%B8%AD%E0%B8%9B/new-bjh/bjh-bangkok/src/app/api/phone-count/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport pool from \"@/lib/db\";\r\nexport async function GET(request: NextRequest) {\r\n  let client;\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const dateParam = searchParams.get(\"date\"); // Format: YYYY-MM-DD (optional)\r\n\r\n    client = await pool.connect();\r\n\r\n    // Query - นับลูกค้าที่มี tag \"phone\" แยกตามวันที่\r\n    let query = `\r\n      SELECT\r\n        ct.assigned_at::date AS date,\r\n        COUNT(DISTINCT ct.customer_id) AS customers_with_phone\r\n      FROM \"BJH-Server\".fb_customer_tags ct\r\n      JOIN \"BJH-Server\".fb_tags t\r\n        ON t.id = ct.tag_id\r\n      WHERE t.name = 'phone'\r\n    `;\r\n\r\n    const queryParams: any[] = [];\r\n\r\n    // Add date filter if provided (for single date)\r\n    if (dateParam) {\r\n      queryParams.push(dateParam);\r\n      query += ` AND ct.assigned_at::date = $${queryParams.length}`;\r\n    }\r\n\r\n    query += `\r\n      GROUP BY ct.assigned_at::date\r\n      ORDER BY date DESC\r\n    `;\r\n\r\n    const result = await client.query(query, queryParams);\r\n\r\n    // Convert to map for easy lookup by date (format: YYYY-MM-DD)\r\n    const phoneCountMap: { [key: string]: number } = {};\r\n    result.rows.forEach((row) => {\r\n      // PostgreSQL returns date as Date object - format it properly\r\n      const date = new Date(row.date);\r\n      const year = date.getFullYear();\r\n      const month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n      const day = String(date.getDate()).padStart(2, \"0\");\r\n      const dateStr = `${year}-${month}-${day}`;\r\n\r\n      phoneCountMap[dateStr] = parseInt(row.customers_with_phone) || 0;\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: phoneCountMap,\r\n      details: result.rows,\r\n      count: result.rows.length,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Database error:\", error);\r\n    let errorMessage = \"Failed to connect to database\";\r\n    if (error.code === \"ETIMEDOUT\" || error.message.includes(\"timeout\")) {\r\n      errorMessage = \"Database connection timeout\";\r\n    } else if (error.code === \"ENOTFOUND\") {\r\n      errorMessage = \"Database host not found\";\r\n    }\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: errorMessage,\r\n        details: error.message,\r\n        code: error.code,\r\n        data: {},\r\n      },\r\n      { status: 500 }\r\n    );\r\n  } finally {\r\n    if (client) {\r\n      client.release();\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AACO,eAAe,IAAI,OAAoB;IAC5C,IAAI;IACJ,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,aAAa,GAAG,CAAC,SAAS,gCAAgC;QAE5E,SAAS,MAAM,6HAAI,CAAC,OAAO;QAE3B,kDAAkD;QAClD,IAAI,QAAQ,CAAC;;;;;;;;IAQb,CAAC;QAED,MAAM,cAAqB,EAAE;QAE7B,gDAAgD;QAChD,IAAI,WAAW;YACb,YAAY,IAAI,CAAC;YACjB,SAAS,CAAC,6BAA6B,EAAE,YAAY,MAAM,EAAE;QAC/D;QAEA,SAAS,CAAC;;;IAGV,CAAC;QAED,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,OAAO;QAEzC,8DAA8D;QAC9D,MAAM,gBAA2C,CAAC;QAClD,OAAO,IAAI,CAAC,OAAO,CAAC,CAAC;YACnB,8DAA8D;YAC9D,MAAM,OAAO,IAAI,KAAK,IAAI,IAAI;YAC9B,MAAM,OAAO,KAAK,WAAW;YAC7B,MAAM,QAAQ,OAAO,KAAK,QAAQ,KAAK,GAAG,QAAQ,CAAC,GAAG;YACtD,MAAM,MAAM,OAAO,KAAK,OAAO,IAAI,QAAQ,CAAC,GAAG;YAC/C,MAAM,UAAU,GAAG,KAAK,CAAC,EAAE,MAAM,CAAC,EAAE,KAAK;YAEzC,aAAa,CAAC,QAAQ,GAAG,SAAS,IAAI,oBAAoB,KAAK;QACjE;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;YACN,SAAS,OAAO,IAAI;YACpB,OAAO,OAAO,IAAI,CAAC,MAAM;QAC3B;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,mBAAmB;QACjC,IAAI,eAAe;QACnB,IAAI,MAAM,IAAI,KAAK,eAAe,MAAM,OAAO,CAAC,QAAQ,CAAC,YAAY;YACnE,eAAe;QACjB,OAAO,IAAI,MAAM,IAAI,KAAK,aAAa;YACrC,eAAe;QACjB;QACA,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO;YACP,SAAS,MAAM,OAAO;YACtB,MAAM,MAAM,IAAI;YAChB,MAAM,CAAC;QACT,GACA;YAAE,QAAQ;QAAI;IAElB,SAAU;QACR,IAAI,QAAQ;YACV,OAAO,OAAO;QAChB;IACF;AACF"}}]
}