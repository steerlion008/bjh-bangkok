{"version":3,"sources":["../../../../src/app/embed/video/%5Bid%5D/page.tsx"],"sourcesContent":["import { notFound } from \"next/navigation\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\n\r\nconst BASE_URL = process.env.NEXT_PUBLIC_BASE_URL || \"https://app.bjhbangkok.com\";\r\nconst VIDEO_ROOT = path.join(process.cwd(), \"public\", \"images\", \"video\");\r\n\r\ninterface VideoInfo {\r\n    url: string;\r\n    mimeType: string;\r\n    thumbnail: string;\r\n}\r\n\r\nasync function getVideoInfo(id: string): Promise<VideoInfo | null> {\r\n    try {\r\n        const decodedPath = Buffer.from(id, \"base64url\").toString(\"utf-8\");\r\n\r\n        // Allow both marketing and images/video paths\r\n        const allowedPrefixes = [\"/marketing/\", \"marketing/\", \"/images/video/\", \"images/video/\"];\r\n        const isAllowed = allowedPrefixes.some((p) => decodedPath.startsWith(p));\r\n        if (!isAllowed) {\r\n            return null;\r\n        }\r\n\r\n        const normalizedPath = decodedPath.startsWith(\"/\") ? decodedPath : `/${decodedPath}`;\r\n        const fullPath = path.join(process.cwd(), \"public\", normalizedPath);\r\n\r\n        // Security: prevent path traversal\r\n        const resolvedPath = path.resolve(fullPath);\r\n        const publicDir = path.resolve(process.cwd(), \"public\");\r\n        if (!resolvedPath.startsWith(publicDir)) {\r\n            return null;\r\n        }\r\n\r\n        if (!fs.existsSync(fullPath)) {\r\n            return null;\r\n        }\r\n\r\n        const ext = path.extname(fullPath).toLowerCase();\r\n        const mimeTypes: Record<string, string> = {\r\n            \".mp4\": \"video/mp4\",\r\n            \".webm\": \"video/webm\",\r\n            \".mov\": \"video/quicktime\",\r\n            \".m4v\": \"video/x-m4v\",\r\n        };\r\n\r\n        // Find thumbnail\r\n        const baseName = path.basename(fullPath, ext);\r\n        const thumbnailCandidates = [\r\n            `${baseName}_thumb.jpg`,\r\n            `${baseName}_thumb.png`,\r\n            `${baseName}.jpg`,\r\n        ];\r\n\r\n        let thumbnail = `${BASE_URL}/images/video-placeholder.svg`;\r\n        for (const thumbName of thumbnailCandidates) {\r\n            const thumbPath = path.join(path.dirname(fullPath), thumbName);\r\n            if (fs.existsSync(thumbPath)) {\r\n                const relativePath = path.relative(path.join(process.cwd(), \"public\"), thumbPath);\r\n                const encodedPath = relativePath.split(path.sep).map(s => encodeURIComponent(s)).join(\"/\");\r\n                thumbnail = `${BASE_URL}/${encodedPath}`;\r\n                break;\r\n            }\r\n        }\r\n\r\n        // URL encode the path for special characters\r\n        const encodedVideoPath = normalizedPath.split(\"/\").map(s => encodeURIComponent(s)).join(\"/\");\r\n\r\n        return {\r\n            url: `${BASE_URL}${encodedVideoPath}`,\r\n            mimeType: mimeTypes[ext] || \"video/mp4\",\r\n            thumbnail,\r\n        };\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\n// Embed page for Twitter Player Card and other embeds\r\nexport default async function VideoEmbedPage({\r\n    params,\r\n}: {\r\n    params: Promise<{ id: string }>;\r\n}) {\r\n    const { id } = await params;\r\n    const video = await getVideoInfo(id);\r\n\r\n    if (!video) {\r\n        notFound();\r\n    }\r\n\r\n    return (\r\n        <html>\r\n            <head>\r\n                <meta charSet=\"utf-8\" />\r\n                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n                <style>{`\r\n          * { margin: 0; padding: 0; box-sizing: border-box; }\r\n          html, body { width: 100%; height: 100%; background: #000; overflow: hidden; }\r\n          video { width: 100%; height: 100%; object-fit: contain; }\r\n        `}</style>\r\n            </head>\r\n            <body>\r\n                <video\r\n                    controls\r\n                    autoPlay\r\n                    playsInline\r\n                    muted\r\n                    preload=\"metadata\"\r\n                    poster={video.thumbnail}\r\n                >\r\n                    <source src={video.url} type={video.mimeType} />\r\n                </video>\r\n            </body>\r\n        </html>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}