{"version":3,"sources":["../../../../src/app/%28fullscreen%29/all-files-gallery/%5BvideoId%5D/VideoShareClient.tsx/__nextjs-internal-proxy.mjs","../../../../src/app/%28fullscreen%29/all-files-gallery/%5BvideoId%5D/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(fullscreen)/all-files-gallery/[videoId]/VideoShareClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(fullscreen)/all-files-gallery/[videoId]/VideoShareClient.tsx\",\n    \"default\",\n);\n","import { Metadata, ResolvingMetadata } from \"next\";\r\nimport { notFound } from \"next/navigation\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport VideoShareClient from \"./VideoShareClient\";\r\n\r\n// Base URL for the application\r\nconst BASE_URL =\r\n    process.env.NEXT_PUBLIC_BASE_URL || \"https://app.bjhbangkok.com\";\r\n\r\n// Directory where videos are stored\r\nconst VIDEO_ROOT = path.join(process.cwd(), \"public\", \"images\", \"video\");\r\nconst CACHE_DIR = path.join(process.cwd(), \"public\", \"cache\", \"line-videos\");\r\n\r\ninterface VideoInfo {\r\n    id: string;\r\n    name: string;\r\n    originalUrl: string;\r\n    lineVideoUrl: string;\r\n    thumbnailUrl: string;\r\n    width: number;\r\n    height: number;\r\n    duration?: number;\r\n    mimeType: string;\r\n    folder: string;\r\n    size: number;\r\n}\r\n\r\n// Parse video ID to extract folder and filename info\r\n// Format: timestamp-index-random or filename without extension\r\nfunction parseVideoId(videoId: string): { folder: string; filename: string } | null {\r\n    // Try to find the file by searching through folders\r\n    return null; // Will search dynamically\r\n}\r\n\r\n// Recursively search for video file by ID pattern\r\nfunction findVideoByPattern(\r\n    dir: string,\r\n    pattern: string,\r\n    basePath: string = \"\"\r\n): { fullPath: string; relativePath: string; folder: string } | null {\r\n    try {\r\n        const entries = fs.readdirSync(dir, { withFileTypes: true });\r\n\r\n        for (const entry of entries) {\r\n            const entryPath = path.join(dir, entry.name);\r\n            const relativePath = basePath ? `${basePath}/${entry.name}` : entry.name;\r\n\r\n            if (entry.isDirectory()) {\r\n                // Skip cache and system folders\r\n                if (entry.name === \"transcoded\" || entry.name === \".git\") continue;\r\n\r\n                const found = findVideoByPattern(entryPath, pattern, relativePath);\r\n                if (found) return found;\r\n            } else if (entry.isFile()) {\r\n                const ext = path.extname(entry.name).toLowerCase();\r\n                const isVideo = [\".mp4\", \".webm\", \".mov\", \".m4v\", \".avi\"].includes(ext);\r\n\r\n                if (isVideo) {\r\n                    // Match by: \r\n                    // 1. Exact filename without extension\r\n                    // 2. Filename contains the pattern\r\n                    // 3. Pattern matches part of filename\r\n                    const nameWithoutExt = path.basename(entry.name, ext);\r\n\r\n                    if (\r\n                        nameWithoutExt === pattern ||\r\n                        entry.name === pattern ||\r\n                        nameWithoutExt.includes(pattern) ||\r\n                        pattern.includes(nameWithoutExt)\r\n                    ) {\r\n                        return {\r\n                            fullPath: entryPath,\r\n                            relativePath,\r\n                            folder: basePath || \"root\",\r\n                        };\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Error searching for video:\", error);\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n// Get video info from filesystem\r\nasync function getVideoInfo(videoId: string): Promise<VideoInfo | null> {\r\n    try {\r\n        // Decode if base64url encoded\r\n        let searchPattern = videoId;\r\n        try {\r\n            const decoded = Buffer.from(videoId, \"base64url\").toString(\"utf-8\");\r\n            if (decoded.includes(\"/images/video/\")) {\r\n                // It's a path-based ID from previous system\r\n                const relativePath = decoded.replace(/^\\/images\\/video\\//, \"\");\r\n                const fullPath = path.join(VIDEO_ROOT, relativePath);\r\n\r\n                if (fs.existsSync(fullPath)) {\r\n                    const stats = fs.statSync(fullPath);\r\n                    const fileName = path.basename(fullPath);\r\n                    const ext = path.extname(fullPath).toLowerCase();\r\n                    const folder = path.dirname(relativePath);\r\n\r\n                    return createVideoInfo(videoId, fullPath, relativePath, folder, stats);\r\n                }\r\n            }\r\n        } catch {\r\n            // Not base64, continue with pattern search\r\n        }\r\n\r\n        // Search for video by pattern\r\n        const found = findVideoByPattern(VIDEO_ROOT, searchPattern);\r\n\r\n        if (!found) {\r\n            return null;\r\n        }\r\n\r\n        const stats = fs.statSync(found.fullPath);\r\n        return createVideoInfo(videoId, found.fullPath, found.relativePath, found.folder, stats);\r\n    } catch (error) {\r\n        console.error(\"Error getting video info:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Create VideoInfo object\r\nfunction createVideoInfo(\r\n    id: string,\r\n    fullPath: string,\r\n    relativePath: string,\r\n    folder: string,\r\n    stats: fs.Stats\r\n): VideoInfo {\r\n    const fileName = path.basename(fullPath);\r\n    const ext = path.extname(fullPath).toLowerCase();\r\n    const nameWithoutExt = path.basename(fileName, ext);\r\n\r\n    // Generate base64url ID for LINE video endpoint\r\n    const pathForId = `/images/video/${relativePath}`;\r\n    const lineVideoId = Buffer.from(pathForId).toString(\"base64url\");\r\n\r\n    // Check for thumbnail\r\n    const thumbnailName = `${nameWithoutExt}_thumb.jpg`;\r\n    const thumbnailPath = path.join(path.dirname(fullPath), thumbnailName);\r\n    const hasThumbnail = fs.existsSync(thumbnailPath);\r\n\r\n    // Generate thumbnail URL or use placeholder\r\n    const thumbnailRelativePath = hasThumbnail\r\n        ? `/images/video/${path.dirname(relativePath)}/${thumbnailName}`\r\n        : null;\r\n\r\n    // Check if transcoded version exists\r\n    const cacheFileName = `${nameWithoutExt}_${lineVideoId.slice(0, 20)}_line.mp4`;\r\n    const transcodedPath = path.join(CACHE_DIR, cacheFileName);\r\n    const hasTranscoded = fs.existsSync(transcodedPath);\r\n\r\n    // Encode path segments for URL safety (handles spaces and special chars)\r\n    const encodedRelativePath = relativePath\r\n        .split(\"/\")\r\n        .map((segment) => encodeURIComponent(segment))\r\n        .join(\"/\");\r\n\r\n    return {\r\n        id,\r\n        name: fileName,\r\n        originalUrl: `${BASE_URL}/images/video/${encodedRelativePath}`,\r\n        lineVideoUrl: hasTranscoded\r\n            ? `${BASE_URL}/api/line-video/${lineVideoId}`\r\n            : `${BASE_URL}/api/serve-video/${encodedRelativePath}`,\r\n        thumbnailUrl: thumbnailRelativePath\r\n            ? `${BASE_URL}${thumbnailRelativePath.split(\"/\").map((s) => encodeURIComponent(s)).join(\"/\")}`\r\n            : `${BASE_URL}/images/video-placeholder.svg`,\r\n        width: 1280,\r\n        height: 720,\r\n        mimeType: \"video/mp4\",\r\n        folder,\r\n        size: stats.size,\r\n    };\r\n}\r\n\r\n// Trigger transcoding in background\r\nasync function triggerTranscoding(videoPath: string): Promise<void> {\r\n    try {\r\n        const response = await fetch(`${BASE_URL}/api/transcode-video`, {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ videoPath }),\r\n        });\r\n        // Fire and forget - don't wait for completion\r\n    } catch (error) {\r\n        console.error(\"Error triggering transcoding:\", error);\r\n    }\r\n}\r\n\r\n// Generate metadata for LINE and social sharing\r\nexport async function generateMetadata(\r\n    { params }: { params: Promise<{ videoId: string }> },\r\n    parent: ResolvingMetadata\r\n): Promise<Metadata> {\r\n    const { videoId } = await params;\r\n    const video = await getVideoInfo(videoId);\r\n\r\n    if (!video) {\r\n        return {\r\n            title: \"Video Not Found\",\r\n            description: \"The requested video could not be found.\",\r\n        };\r\n    }\r\n\r\n    const pageUrl = `${BASE_URL}/all-files-gallery/${videoId}`;\r\n\r\n    // Trigger transcoding if not already done (fire and forget)\r\n    if (!video.lineVideoUrl.includes(\"/api/line-video/\")) {\r\n        const pathForTranscode = `/images/video/${video.folder}/${video.name}`;\r\n        triggerTranscoding(pathForTranscode);\r\n    }\r\n\r\n    return {\r\n        title: `${video.name} - BJH Bangkok`,\r\n        description: `Watch ${video.name} from BJH Bangkok`,\r\n\r\n        // Open Graph for video - Critical for LINE inline playback\r\n        openGraph: {\r\n            title: video.name,\r\n            description: `Watch ${video.name} from BJH Bangkok`,\r\n            url: pageUrl,\r\n            siteName: \"BJH Bangkok\",\r\n            type: \"video.other\",\r\n            images: [\r\n                {\r\n                    url: video.thumbnailUrl,\r\n                    width: video.width,\r\n                    height: video.height,\r\n                    alt: video.name,\r\n                },\r\n            ],\r\n            videos: [\r\n                {\r\n                    url: video.lineVideoUrl,\r\n                    secureUrl: video.lineVideoUrl,\r\n                    type: video.mimeType,\r\n                    width: video.width,\r\n                    height: video.height,\r\n                },\r\n            ],\r\n        },\r\n\r\n        // Twitter Card for video\r\n        twitter: {\r\n            card: \"player\",\r\n            title: video.name,\r\n            description: `Watch ${video.name} from BJH Bangkok`,\r\n            images: [video.thumbnailUrl],\r\n        },\r\n\r\n        // Additional meta tags\r\n        other: {\r\n            // LINE specific tags\r\n            \"line:title\": video.name,\r\n            \"line:description\": `Watch ${video.name}`,\r\n\r\n            // Video meta tags\r\n            \"video:duration\": video.duration?.toString() || \"\",\r\n            \"video:release_date\": new Date().toISOString(),\r\n\r\n            // Apple specific for inline video\r\n            \"apple-mobile-web-app-capable\": \"yes\",\r\n\r\n            // Additional OG video tags as fallback\r\n            \"og:video\": video.lineVideoUrl,\r\n            \"og:video:secure_url\": video.lineVideoUrl,\r\n            \"og:video:type\": video.mimeType,\r\n            \"og:video:width\": String(video.width),\r\n            \"og:video:height\": String(video.height),\r\n        },\r\n    };\r\n}\r\n\r\n// Page component\r\nexport default async function VideoSharePage({\r\n    params,\r\n}: {\r\n    params: Promise<{ videoId: string }>;\r\n}) {\r\n    const { videoId } = await params;\r\n    const video = await getVideoInfo(videoId);\r\n\r\n    if (!video) {\r\n        notFound();\r\n    }\r\n\r\n    // Create share URL for LINE\r\n    const shareUrl = `${BASE_URL}/all-files-gallery/${videoId}`;\r\n    const lineShareUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(shareUrl)}`;\r\n\r\n    return (\r\n        <VideoShareClient\r\n            video={video}\r\n            shareUrl={shareUrl}\r\n            lineShareUrl={lineShareUrl}\r\n        />\r\n    );\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[0]}