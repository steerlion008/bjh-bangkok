module.exports=[193695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},270406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},918622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},230056,e=>e.a(async(t,a)=>{try{let t=await e.y("pg");e.n(t),a()}catch(e){a(e)}},!0),843793,e=>e.a(async(t,a)=>{try{var r=e.i(230056),s=t([r]);[r]=s.then?(await s)():s,r.types.setTypeParser(r.types.builtins.DATE,e=>e),r.types.setTypeParser(r.types.builtins.TIMESTAMP,e=>e),r.types.setTypeParser(r.types.builtins.TIMESTAMPTZ,e=>e);let n=new r.Pool({host:process.env.DB_HOST||"n8n.bjhbangkok.com",port:parseInt(process.env.DB_PORT||"5432"),user:process.env.DB_USER||"postgres",password:process.env.DB_PASSWORD||"Bjh12345!!",database:process.env.DB_NAME||"postgres",max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:3e4,statement_timeout:6e4,query_timeout:6e4,ssl:!1});n.on("connect",()=>{}),n.on("error",e=>{}),e.s(["default",0,n]),a()}catch(e){a(e)}},!1),10628,e=>e.a(async(t,a)=>{try{var r=e.i(89171),s=e.i(843793),n=t([s]);[s]=n.then?(await n)():n;let i=new Map;async function o(e){try{let{searchParams:t}=new URL(e.url),a=t.get("startDate"),n=t.get("endDate"),o=t.get("month"),l=t.get("year"),d=`crm-advanced-${a||"all"}-${n||"all"}-${o||"all"}-${l||"all"}`,u=i.get(d),c=Date.now();if(u&&c<u.expiresAt)return console.log(`âœ… Returning cached CRM advanced data`),r.NextResponse.json(u.data,{status:200,headers:{"Cache-Control":"public, s-maxage=30, stale-while-revalidate=60","X-Cache-Status":"HIT","X-Data-Source":"PostgreSQL Database (Cached)"}});console.log(`ðŸ“¡ Fetching CRM advanced data from database...`);let p=`
      SELECT 
        bl.id,
        bl.appointment_time,
        bl.status,
        bl.customer_name,
        bl.phone,
        bl.interested_product,
        bl.doctor,
        bl.contact_staff,
        bl.proposed_amount,
        bl.star_flag,
        bl.country,
        bl.note,
        bl.surgery_date,
        bl.consult_date,
        nc.id_all AS customer_id_all
      FROM "BJH-Server"."bjh_all_leads" bl
      LEFT JOIN LATERAL (
        SELECT nc_sub.id_all
        FROM "BJH-Server".n_customer nc_sub
        WHERE nc_sub.id_all = bl.id::text
        LIMIT 1
      ) nc ON true
      WHERE 
        1=1
    `,h=[],m=1;o&&l?(p+=` AND (
        (bl.status = 'à¸™à¸±à¸” Consult' AND bl.consult_date IS NOT NULL AND EXTRACT(MONTH FROM bl.consult_date::date) = $${m} AND EXTRACT(YEAR FROM bl.consult_date::date) = $${m+1})
        OR 
        (bl.status = 'à¸™à¸±à¸”à¸žà¸£à¹‰à¸­à¸¡à¸—à¸³' AND bl.surgery_date IS NOT NULL AND EXTRACT(MONTH FROM bl.surgery_date::date) = $${m} AND EXTRACT(YEAR FROM bl.surgery_date::date) = $${m+1})
      )`,h.push(parseInt(o),parseInt(l)),m+=2):a&&a===n?(p+=` AND (
        (bl.status = 'à¸™à¸±à¸” Consult' AND bl.consult_date::date = $${m}::date)
        OR 
        (bl.status = 'à¸™à¸±à¸”à¸žà¸£à¹‰à¸­à¸¡à¸—à¸³' AND bl.surgery_date::date = $${m}::date)
      )`,h.push(a),m+=1):a&&n?(p+=` AND (
        (bl.status = 'à¸™à¸±à¸” Consult' AND bl.consult_date::date BETWEEN $${m}::date AND $${m+1}::date)
        OR 
        (bl.status = 'à¸™à¸±à¸”à¸žà¸£à¹‰à¸­à¸¡à¸—à¸³' AND bl.surgery_date::date BETWEEN $${m}::date AND $${m+1}::date)
      )`,h.push(a,n),m+=2):p+=` AND (
        (bl.status = 'à¸™à¸±à¸” Consult' AND bl.consult_date IS NOT NULL)
        OR 
        (bl.status = 'à¸™à¸±à¸”à¸žà¸£à¹‰à¸­à¸¡à¸—à¸³' AND bl.surgery_date IS NOT NULL)
      )`,p+=` ORDER BY 
      CASE 
        WHEN bl.status = 'à¸™à¸±à¸” Consult' THEN bl.consult_date::date
        WHEN bl.status = 'à¸™à¸±à¸”à¸žà¸£à¹‰à¸­à¸¡à¸—à¸³' THEN bl.surgery_date::date
      END ASC,
      bl.appointment_time ASC
    `;let R=await s.default.connect();try{let e=await R.query(p,h);console.log(`âœ… Successfully fetched ${e.rows.length} CRM records from database`);let t={success:!0,data:e.rows.map(e=>{var t;let a=e=>{if(!e)return"";let t=String(e);return t.includes("T")?t.split("T")[0]:t.includes(" ")?t.split(" ")[0]:t};return{id:e.id,appointmentTime:(t=e.appointment_time)?"string"==typeof t?t:String(t):"",status:e.status||"",customer_name:e.customer_name||"",phone:e.phone||"",interested_product:e.interested_product||"",doctor:e.doctor||"",contact_staff:e.contact_staff||"",proposed_amount:parseFloat(e.proposed_amount||0),proposedAmount:parseFloat(e.proposed_amount||0),star_flag:e.star_flag||"",country:e.country||"",note:e.note||"",surgery_date:a(e.surgery_date),consult_date:a(e.consult_date),hasCustomerProfile:!!e.customer_id_all,customerIdAll:e.customer_id_all||"",displayDate:a(e.surgery_date)||a(e.consult_date)||e.appointment_time||""}}),total:e.rows.length,timestamp:new Date().toISOString(),source:"PostgreSQL Database",debug:{filters:{startDate:a||"all",endDate:n||"all",month:o||"all",year:l||"all"}}};for(let[e,a]of(i.set(d,{data:t,timestamp:c,expiresAt:c+3e4}),i.entries()))c>a.expiresAt+6e4&&i.delete(e);return r.NextResponse.json(t,{status:200,headers:{"Cache-Control":"public, s-maxage=30, stale-while-revalidate=60","X-Cache-Status":"MISS","X-Data-Source":"PostgreSQL Database (Fresh)"}})}finally{R.release()}}catch(t){console.error("Error fetching CRM advanced data:",t);let e=i.get("crm-advanced");if(e)return console.log("âš ï¸ Using expired cache due to database error"),r.NextResponse.json(e.data,{status:200,headers:{"X-Cache-Status":"STALE","X-Data-Source":"Database (Error Fallback)"}});return r.NextResponse.json({success:!1,error:t.message||"Failed to fetch CRM data",details:{type:t.name,message:t.message,hint:"à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² database connection à¸—à¸³à¸‡à¸²à¸™à¸›à¸à¸•à¸´"},data:[]},{status:500})}}async function l(e){return new r.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}e.s(["GET",()=>o,"OPTIONS",()=>l]),a()}catch(e){a(e)}},!1),697487,e=>e.a(async(t,a)=>{try{var r=e.i(747909),s=e.i(174017),n=e.i(996250),o=e.i(759756),l=e.i(561916),i=e.i(114444),d=e.i(837092),u=e.i(869741),c=e.i(316795),p=e.i(487718),h=e.i(995169),m=e.i(47587),R=e.i(666012),g=e.i(570101),b=e.i(626937),_=e.i(10372),y=e.i(193695);e.i(52474);var E=e.i(600220),x=e.i(10628),A=t([x]);[x]=A.then?(await A)():A;let T=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/crm-advanced/route",pathname:"/api/crm-advanced",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/crm-advanced/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:N,workUnitAsyncStorage:C,serverHooks:w}=T;function v(){return(0,n.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:C})}async function f(e,t,a){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/crm-advanced/route";r=r.replace(/\/index$/,"")||"/";let n=await T.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:x,params:A,nextConfig:v,parsedUrl:f,isDraftMode:N,prerenderManifest:C,routerServerContext:w,isOnDemandRevalidate:S,revalidateOnlyGenerated:D,resolvedPathname:O,clientReferenceManifest:M,serverActionsManifest:P}=n,$=(0,u.normalizeAppPath)(r),I=!!(C.dynamicRoutes[$]||C.routes[O]),H=async()=>((null==w?void 0:w.render404)?await w.render404(e,t,f,!1):t.end("This page could not be found"),null);if(I&&!N){let e=!!C.routes[O],t=C.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await H();throw new y.NoFallbackError}}let j=null;!I||T.isDev||N||(j=O,j="/index"===j?"/":j);let k=!0===T.isDev||!I,L=I&&!k;P&&M&&(0,i.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:M,serverActionsManifest:P,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:P})});let U=e.method||"GET",q=(0,l.getTracer)(),F=q.getActiveScopeSpan(),B={params:A,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>T.onRequestError(e,t,r,w)},sharedContext:{buildId:x}},X=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(X,(0,p.signalFromNodeResponse)(t));try{let n=async e=>T.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${r}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var l,d;let u=async({previousCacheEntry:s})=>{try{if(!i&&S&&D&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!I)return await (0,R.sendResponse)(X,W,r,B.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[_.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,s=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:S})},w),t}},c=await T.handleResponse({req:e,nextConfig:v,cacheKey:j,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:D,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!I)return null;if((null==c||null==(l=c.value)?void 0:l.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&I||p.delete(_.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,b.getCacheControlHeader)(c.cacheControl)),await (0,R.sendResponse)(X,W,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};F?await d(F):await q.withPropagatedContext(e.headers,()=>q.trace(h.BaseServerSpan.handleRequest,{spanName:`${U} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:S})}),I)throw t;return await (0,R.sendResponse)(X,W,new Response(null,{status:500})),null}}e.s(["handler",()=>f,"patchFetch",()=>v,"routeModule",()=>T,"serverHooks",()=>w,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>C]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__52716c79._.js.map